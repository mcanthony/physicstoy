function Color(){}function Renderer(a,b){p2.EventEmitter.call(this),b=b||{},this.setWorld(a),window.app=this;var c=this;this.state=Renderer.DEFAULT,this.defaultState=Renderer.DEFAULT,this.bodies=[],this.springs=[],this.timeStep=1/60,this.resetTime=!1,this.relaxation=p2.Equation.DEFAULT_RELAXATION,this.stiffness=p2.Equation.DEFAULT_STIFFNESS,this.maxSubSteps=3,this.mouseConstraint=null,this.nullBody=new p2.Body,this.pickPrecision=5,this.lastMouseDownPhysicsPosition=p2.vec2.create(),this.useInterpolatedPositions=!1,this.drawPoints=[],this.drawAABBs=!1,this.drawPointsChangeEvent={type:"drawPointsChange"},this.drawCircleCenter=p2.vec2.create(),this.drawCirclePoint=p2.vec2.create(),this.drawCircleChangeEvent={type:"drawCircleChange"},this.drawRectangleChangeEvent={type:"drawRectangleChange"},this.drawRectStart=p2.vec2.create(),this.drawRectEnd=p2.vec2.create(),this.stateChangeEvent={type:"stateChange",state:null},this.selectionChangeEvent={type:"selectionChange"},this.selection=[],this.selectionEnabled=!1,this.newShapeCollisionMask=1,this.newShapeCollisionGroup=1,this.drawConstraints=!1,this.stats_sum=0,this.stats_N=100,this.stats_Nsummed=0,this.stats_average=-1,this.addedGlobals=[],this.settings={tool:Renderer.DEFAULT,fullscreen:function(){var a=document.body,b=a.requestFullscreen||a.msRequestFullscreen||a.mozRequestFullScreen||a.webkitRequestFullscreen;b&&b.call(a)},"paused [p]":!1,"manualStep [s]":function(){c.world.step(c.world.lastTimeStep)},fps:60,maxSubSteps:3,gravityX:0,gravityY:-10,sleepMode:p2.World.NO_SLEEPING,"drawContacts [c]":!1,"drawAABBs [t]":!1,drawConstraints:!1,iterations:10,stiffness:1e6,relaxation:4,tolerance:1e-4},this.init(),this.resizeToFit(),this.render(),this.centerCamera(0,0),this.paused=!0,window.onresize=function(){c.resizeToFit()},this.setUpKeyboard(),this.startRenderingLoop()}function WebGLRenderer(a,b){b=b||{};var c=this,d={lineWidth:.01,scrollFactor:.1,width:1280,height:720,useDeviceAspect:!1,sleepOpacity:.2};for(var e in b)d[e]=b[e];d.useDeviceAspect&&(d.height=window.innerHeight/window.innerWidth*d.width),this.lineWidth=d.lineWidth,this.scrollFactor=d.scrollFactor,this.sleepOpacity=d.sleepOpacity,this.sprites=[],this.springSprites=[],this.debugPolygons=!1,Renderer.call(this,a,b);for(var e in d)this.settings[e]=d[e];this.pickPrecision=.1,this.on("drawPointsChange",function(){var a=c.drawShapeGraphics,b=c.drawPoints;a.clear();for(var d=[],e=0;e<b.length;e++){var f=b[e];d.push([f[0],f[1]])}c.drawPath(a,d,16711680,!1,c.lineWidth,!1)}),this.on("drawCircleChange",function(){var a=c.drawShapeGraphics;a.clear();var b=c.drawCircleCenter,d=p2.vec2.dist(b,c.drawCirclePoint);c.drawCircle(a,b[0],b[1],0,d,!1,c.lineWidth)}),this.on("drawRectangleChange",function(){var a=c.drawShapeGraphics;a.clear();var b=c.drawRectStart,d=c.drawRectEnd,e=b[0]-d[0],f=b[1]-d[1];c.drawRectangle(a,b[0]-e/2,b[1]-f/2,0,e,f,!1,!1,c.lineWidth,!1)})}function componentToHex(a){var b=a.toString(16);return 1===b.length?"0"+b:b}function rgbToHex(a,b,c){return componentToHex(a)+componentToHex(b)+componentToHex(c)}function randomPastelHex(){var a=[255,255,255],b=Math.floor(256*Math.random()),c=Math.floor(256*Math.random()),d=Math.floor(256*Math.random());return b=Math.floor((b+3*a[0])/4),c=Math.floor((c+3*a[1])/4),d=Math.floor((d+3*a[2])/4),rgbToHex(b,c,d)}function Handler(){this.objects={}}function RendererHandler(a){Handler.call(this),this.renderer=a}function SolverHandler(a){Handler.call(this),this.world=a}function ShapeHandler(a,b,c){Handler.call(this),this.world=b,this.renderer=c,this.sceneHandler=a}function WorldHandler(a,b,c){Handler.call(this),this.sceneHandler=a,this.world=b,this.renderer=c}function SpringHandler(a,b,c){Handler.call(this),this.sceneHandler=a,this.world=b,this.renderer=c}function ConstraintHandler(a,b,c){Handler.call(this),this.sceneHandler=a,this.world=b,this.renderer=c}function MachineHandler(a,b,c){Handler.call(this),this.sceneHandler=a,this.world=b,this.renderer=c;var d=this;b.on("postStep",function(){for(var a=Object.keys(d.objects),b=0;b<a.length;b++){var c=d.objects[a[b]];c.update()}})}function MaterialHandler(a,b,c){Handler.call(this),this.sceneHandler=a,this.world=b,this.renderer=c}function ContactMaterialHandler(a,b,c){Handler.call(this),this.sceneHandler=a,this.world=b,this.renderer=c}function BodyHandler(a,b,c){Handler.call(this),this.world=b,this.renderer=c,this.sceneHandler=a}function ActionHandler(a,b,c){Handler.call(this),this.sceneHandler=a,this.world=b,this.renderer=c}function StateHandler(a,b,c){Handler.call(this),this.sceneHandler=a,this.world=b,this.renderer=c}function SceneHandler(a,b){this.world=a,this.renderer=b,this.rendererHandler=new RendererHandler(b),this.solverHandler=new SolverHandler(a),this.bodyHandler=new BodyHandler(this,a,b),this.shapeHandler=new ShapeHandler(this,a,b),this.springHandler=new SpringHandler(this,a,b),this.worldHandler=new WorldHandler(this,a,b),this.machineHandler=new MachineHandler(this,a,b),this.stateHandler=new StateHandler(this,a,b),this.actionHandler=new ActionHandler(this,a,b),this.constraintHandler=new ConstraintHandler(this,a,b),this.materialHandler=new MaterialHandler(this,a,b),this.contactMaterialHandler=new ContactMaterialHandler(this,a,b)}function Machine(a,b,c){c=c||{},this.world=a,this.parent=b||null,this.id=c.id||0,this.states=c.states?c.states.slice(0):[],this.currentState=null,this.defaultState=c.defaultState||null,this.requestTransitionToState=null,this.logging=!0}function State(a){this.id=++State.id,this.actions=[],this.machine=a}function Action(a){a=a||{},this.state=a.state||null}function KeyAction(a){Action.apply(this,arguments),a=a||{},this.keyCode=a.keyCode||-1,this.eventType=a.eventType||"keydown",this.toState=a.toState||null,this.eventHandler=a.eventHandler||null,this.triggered=!1}function SetPositionAction(a){Action.apply(this,arguments),a=a||{},this.position=a.position?a.position.slice(0):[0,0],this.angle=a.angle||0}function SetVelocityAction(a){Action.apply(this,arguments),a=a||{},this.velocity=a.velocity?a.velocity.slice(0):[0,0],this.angularVelocity=a.angularVelocity||0,this.localFrame=a.localFrame||!1}function WaitAction(a){Action.apply(this,arguments),a=a||{},this.time="undefined"!=typeof a.time?a.time:1,this.toState=a.toState||null,this.enterTime=-1}function AddForceAction(a){Action.apply(this,arguments),a=a||{},this.force=a.force?a.force.slice(0):[0,0],this.angularForce=a.angularForce||0,this.localFrame=a.localFrame||!1,this.tmpVec=p2.vec2.create()}Color.componentToHex=function(a){var b=a.toString(16);return 1===b.length?"0"+b:b},Color.rgbToHex=function(a,b,c){return Color.componentToHex(a)+Color.componentToHex(b)+Color.componentToHex(c)},Color.randomPastelHex=function(){var a=[255,255,255],b=Math.floor(256*Math.random()),c=Math.floor(256*Math.random()),d=Math.floor(256*Math.random());return b=Math.floor((b+3*a[0])/4),c=Math.floor((c+3*a[1])/4),d=Math.floor((d+3*a[2])/4),Color.rgbToHex(b,c,d)};var requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)},disableSelectionCSS=["-ms-user-select: none","-moz-user-select: -moz-none","-khtml-user-select: none","-webkit-user-select: none","user-select: none"];Renderer.prototype=new p2.EventEmitter,Renderer.DEFAULT=1,Renderer.PANNING=2,Renderer.DRAGGING=3,Renderer.DRAWPOLYGON=4,Renderer.DRAWINGPOLYGON=5,Renderer.DRAWCIRCLE=6,Renderer.DRAWINGCIRCLE=7,Renderer.DRAWRECTANGLE=8,Renderer.DRAWINGRECTANGLE=9,Renderer.PANZOOM=10,Renderer.toolStateMap={"pick/pan [q]":Renderer.DEFAULT,"polygon [d]":Renderer.DRAWPOLYGON,"circle [a]":Renderer.DRAWCIRCLE,"rectangle [f]":Renderer.DRAWRECTANGLE},Renderer.stateToolMap={};for(var key in Renderer.toolStateMap)Renderer.stateToolMap[Renderer.toolStateMap[key]]=key;Renderer.keydownEvent={type:"keydown",originalEvent:null,keyCode:0},Renderer.keyupEvent={type:"keyup",originalEvent:null,keyCode:0},Object.defineProperty(Renderer.prototype,"drawContacts",{get:function(){return this.settings["drawContacts [c]"]},set:function(a){this.settings["drawContacts [c]"]=a}}),Object.defineProperty(Renderer.prototype,"paused",{get:function(){return this.settings["paused [p]"]},set:function(a){this.settings["paused [p]"]=a}}),Renderer.prototype.getDevicePixelRatio=function(){return window.devicePixelRatio||1},Renderer.prototype.resizeToFit=function(){var a=this.getDevicePixelRatio(),b=window.innerWidth*a,c=window.innerHeight*a;this.resize(b,c)},Renderer.prototype.setWorld=function(a){this.world=a,window.world=a;var b=this;a.on("postStep",function(){b.updateStats()}).on("addBody",function(a){b.addVisual(a.body)}).on("removeBody",function(a){b.removeVisual(a.body)}).on("addSpring",function(a){b.addVisual(a.spring)}).on("removeSpring",function(a){b.removeVisual(a.spring)})},Renderer.elementClass="p2-canvas",Renderer.containerClass="p2-container",Renderer.prototype.clearSelection=function(){this.selection.length;this.selection.length=0,this.emit(this.selectionChangeEvent)},Renderer.prototype.enableSelection=function(){this.selectionEnabled=!0},Renderer.prototype.disableSelection=function(){this.clearSelection(),this.selectionEnabled=!0},Renderer.prototype.toggleSelect=function(a){var b=this.selection,c=b.indexOf(a);-1===c?b.push(a):b.splice(c,1),this.emit(this.selectionChangeEvent)},Renderer.prototype.removeFromSelection=function(a){var b=this.selection,c=b.indexOf(a);-1!==c&&(b.splice(c,1),this.emit(this.selectionChangeEvent))},Renderer.prototype.setUpKeyboard=function(){var a=this;this.elementContainer.onkeydown=function(b){if(b.keyCode){var c=(a.state,String.fromCharCode(b.keyCode));switch(c){case"P":a.paused=!a.paused;break;case"S":a.world.step(a.world.lastTimeStep);break;case"C":a.drawContacts=!a.drawContacts,a.drawConstraints=!a.drawConstraints;break;case"T":a.drawAABBs=!a.drawAABBs;break;case"Q":a.setState(a.defaultState);break;default:Renderer.keydownEvent.keyCode=b.keyCode,Renderer.keydownEvent.originalEvent=b,a.emit(Renderer.keydownEvent)}}},this.elementContainer.onkeyup=function(b){if(b.keyCode)switch(String.fromCharCode(b.keyCode)){default:Renderer.keyupEvent.keyCode=b.keyCode,Renderer.keyupEvent.originalEvent=b,a.emit(Renderer.keyupEvent)}}},Renderer.prototype.startRenderingLoop=function(){function a(){if(!b.paused){var d=Date.now()/1e3,e=d-c;c=d,b.resetTime&&(e=0,b.resetTime=!1,b.world.time=0),b.world.step(b.timeStep,e,b.maxSubSteps)}b.render(),requestAnimFrame(a)}var b=this,c=Date.now()/1e3;requestAnimFrame(a)},Renderer.prototype.setState=function(a){this.state=a,this.stateChangeEvent.state=a,this.emit(this.stateChangeEvent),Renderer.stateToolMap[a]&&(this.settings.tool=a)},Renderer.prototype.handleMouseDown=function(a){switch(this.state){case Renderer.DEFAULT:for(var b,c=this.world.hitTest(a,this.world.bodies,this.pickPrecision);c.length>0&&(b=c.shift(),b.type===p2.Body.STATIC);)b=null;if(b){b.wakeUp(),this.setState(Renderer.DRAGGING);var d=p2.vec2.create();b.toLocalFrame(d,a),this.world.addBody(this.nullBody),this.mouseConstraint=new p2.RevoluteConstraint(this.nullBody,b,{localPivotA:a,localPivotB:d}),this.world.addConstraint(this.mouseConstraint)}else this.setState(Renderer.PANNING);break;case Renderer.PANZOOM:this.setState(Renderer.PANNING);break;case Renderer.DRAWPOLYGON:this.setState(Renderer.DRAWINGPOLYGON),this.drawPoints=[];var e=p2.vec2.create();p2.vec2.copy(e,a),this.drawPoints.push(e),this.emit(this.drawPointsChangeEvent);break;case Renderer.DRAWCIRCLE:this.setState(Renderer.DRAWINGCIRCLE),p2.vec2.copy(this.drawCircleCenter,a),p2.vec2.copy(this.drawCirclePoint,a),this.emit(this.drawCircleChangeEvent);break;case Renderer.DRAWRECTANGLE:this.setState(Renderer.DRAWINGRECTANGLE),p2.vec2.copy(this.drawRectStart,a),p2.vec2.copy(this.drawRectEnd,a),this.emit(this.drawRectangleChangeEvent)}p2.vec2.copy(this.lastMouseDownPhysicsPosition,a)},Renderer.prototype.handleMouseMove=function(a){var b=.4;switch(this.state){case Renderer.DEFAULT:case Renderer.DRAGGING:this.mouseConstraint&&(p2.vec2.copy(this.mouseConstraint.pivotA,a),this.mouseConstraint.bodyA.wakeUp(),this.mouseConstraint.bodyB.wakeUp());break;case Renderer.DRAWINGPOLYGON:var c=p2.vec2.dist(a,this.drawPoints[this.drawPoints.length-1]);if(c>b*b){var d=[0,0];p2.vec2.copy(d,a),this.drawPoints.push(d),this.emit(this.drawPointsChangeEvent)}break;case Renderer.DRAWINGCIRCLE:p2.vec2.copy(this.drawCirclePoint,a),this.emit(this.drawCircleChangeEvent);break;case Renderer.DRAWINGRECTANGLE:p2.vec2.copy(this.drawRectEnd,a),this.emit(this.drawRectangleChangeEvent)}},Renderer.prototype.handleMouseUp=function(){var a;switch(this.state){case Renderer.DEFAULT:case Renderer.PANZOOM:break;case Renderer.DRAGGING:this.world.removeConstraint(this.mouseConstraint),this.mouseConstraint=null,this.world.removeBody(this.nullBody),this.setState(this.defaultState);break;case Renderer.PANNING:this.setState(this.defaultState);break;case Renderer.DRAWINGPOLYGON:this.setState(Renderer.DRAWPOLYGON),this.drawPoints.length>3&&(a=new p2.Body({mass:1}),a.fromPolygon(this.drawPoints,{removeCollinearPoints:.01})&&this.world.addBody(a)),this.drawPoints=[],this.emit(this.drawPointsChangeEvent);break;case Renderer.DRAWINGCIRCLE:this.setState(Renderer.DRAWCIRCLE);var b=p2.vec2.dist(this.drawCircleCenter,this.drawCirclePoint);if(b>0){a=new p2.Body({mass:1,position:this.drawCircleCenter});var c=new p2.Circle(b);a.addShape(c),this.world.addBody(a)}p2.vec2.copy(this.drawCircleCenter,this.drawCirclePoint),this.emit(this.drawCircleChangeEvent);break;case Renderer.DRAWINGRECTANGLE:this.setState(Renderer.DRAWRECTANGLE);for(var d=this.drawRectStart,e=this.drawRectEnd,f=0;2>f;f++)if(d[f]>e[f]){var g=e[f];e[f]=d[f],d[f]=g}var h=Math.abs(d[0]-e[0]),i=Math.abs(d[1]-e[1]);if(h>0&&i>0){a=new p2.Body({mass:1,position:[this.drawRectStart[0]+.5*h,this.drawRectStart[1]+.5*i]});var j=new p2.Rectangle(h,i);a.addShape(j),this.world.addBody(a)}p2.vec2.copy(this.drawRectEnd,this.drawRectStart),this.emit(this.drawRectangleChangeEvent)}if(a){a.wakeUp();for(var f=0;f<a.shapes.length;f++){var k=a.shapes[f];k.collisionMask=this.newShapeCollisionMask,k.collisionGroup=this.newShapeCollisionGroup}}},p2.World.prototype.hitTest2=function(a,b,c){c=c||0;var d=new p2.Body({position:a}),e=new p2.Particle,f=a,g=0,h=[0,0],i=[0,0],j=[0,0];d.addShape(e);for(var k=this.narrowphase,l=[],m=0,n=b.length;m!==n;m++)for(var o=b[m],p=0,q=o.shapes.length;p!==q;p++){var r=o.shapes[p],s=o.shapeOffsets[p]||i,t=o.shapeAngles[p]||0;p2.vec2.rotate(h,s,o.angle),p2.vec2.add(h,h,o.position);var u=t+o.angle;(r instanceof p2.Circle&&k.circleParticle(o,r,h,u,d,e,f,g,!0)||r instanceof p2.Convex&&k.particleConvex(d,e,f,g,o,r,h,u,!0)||r instanceof p2.Plane&&k.particlePlane(d,e,f,g,o,r,h,u,!0)||r instanceof p2.Capsule&&k.particleCapsule(d,e,f,g,o,r,h,u,!0)||r instanceof p2.Particle&&p2.vec2.squaredLength(vec2.sub(j,h,a))<c*c)&&l.push(r)}return l},Renderer.prototype.handleClick=function(a){var b=this.world.hitTest(a,this.world.bodies,this.pickPrecision),c=this.world.hitTest2(a,this.world.bodies,this.pickPrecision);this.emit({type:"click",targets:b.concat(c)})},Renderer.prototype.handleDoubleClick=function(a){var b=this.world.hitTest(a,this.world.bodies,this.pickPrecision),c=this.world.hitTest2(a,this.world.bodies,this.pickPrecision);this.emit({type:"dblclick",targets:b.concat(c)})},Renderer.prototype.updateStats=function(){this.stats_sum+=this.world.lastStepTime,this.stats_Nsummed++,this.stats_Nsummed===this.stats_N&&(this.stats_average=this.stats_sum/this.stats_N,this.stats_sum=0,this.stats_Nsummed=0)},Renderer.prototype.addVisual=function(a){a instanceof p2.Spring&&-1===this.springs.indexOf(a)?(this.springs.push(a),this.addRenderable(a)):a instanceof p2.Body&&-1===this.bodies.indexOf(a)&&a.shapes.length&&(this.bodies.push(a),this.addRenderable(a))},Renderer.prototype.removeAllVisuals=function(){for(var a=this.bodies,b=this.springs;a.length;)this.removeVisual(a[a.length-1]);for(;b.length;)this.removeVisual(b[b.length-1])},Renderer.prototype.removeVisual=function(a){if(this.removeRenderable(a),a instanceof p2.Spring){var b=this.springs.indexOf(a);-1!==b&&this.springs.splice(b,1)}else if(a instanceof p2.Body){var b=this.bodies.indexOf(a);-1!==b&&this.bodies.splice(b,1)}else console.warn("Renderer.prototype.removeVisual: Visual type not recognized...")},Renderer.prototype.addFullScreenButton=function(){var a=document.createElement("div");a.innerHTML='<a onclick="window.screenfull && screenfull.request()" class="fullscreen-button"><img src="/img/fullscreen.png"/></a>',document.body.appendChild(a)},Renderer.zoomInEvent={type:"zoomin"},Renderer.zoomOutEvent={type:"zoomout"},Renderer.prototype.setEquationParameters=function(){this.world.setGlobalEquationParameters({stiffness:this.settings.stiffness,relaxation:this.settings.relaxation})},WebGLRenderer.prototype=Object.create(Renderer.prototype),WebGLRenderer.prototype.stagePositionToPhysics=function(a,b){var c=b[0],d=b[1];return p2.vec2.set(a,c,d),a};var init_stagePosition=p2.vec2.create(),init_physicsPosition=p2.vec2.create();WebGLRenderer.prototype.init=function(){function a(a){a=window.event||a;var b,d=a,e=d.detail,f=d.wheelDelta,g=225,h=g-1;e=e?f&&(b=f/e)?e/b:-e/1.35:f/120,e=1>e?-1>e?(-Math.pow(e,2)-h)/g:e:(Math.pow(e,2)+h)/g;var i=Math.min(Math.max(e/2,-1),1),l=i>=0;"undefined"!=typeof j&&c.zoom(j,k,l,void 0,void 0,i),a.preventDefault()}var b=(this.w,this.h,this.settings),c=this,d=(this.renderer=PIXI.autoDetectRenderer(b.width,b.height,null,null,!0),this.stage=new PIXI.DisplayObjectContainer),e=this.container=new PIXI.Stage(16777215,!0),f=this.element=this.renderer.view;f.tabIndex=1,f.classList.add(Renderer.elementClass),f.setAttribute("style","width:100%;");var g=this.elementContainer=document.getElementById("p2-container");g.setAttribute("style","width:100%; height:100%"),g.appendChild(f),f.focus(),f.oncontextmenu=function(){return!1},this.container.addChild(d),this.drawShapeGraphics=new PIXI.Graphics,d.addChild(this.drawShapeGraphics),this.contactGraphics=new PIXI.Graphics,d.addChild(this.contactGraphics),this.aabbGraphics=new PIXI.Graphics,d.addChild(this.aabbGraphics),this.selectionGraphics=new PIXI.Graphics,d.addChild(this.selectionGraphics),d.scale.x=200,d.scale.y=-200;var h,i,j,k,l,m,n,o,p=!1,q=p2.vec2.create(),r=p2.vec2.create(),s=p2.vec2.create(),t=0,u=1,v=1,w=0;e.mousedown=e.touchstart=function(a){if(j=n=a.global.x,k=o=a.global.y,a.originalEvent.touches&&(w=a.originalEvent.touches.length),a.originalEvent.touches&&2===a.originalEvent.touches.length){var b=c.container.interactionManager.touchs[0],e=c.container.interactionManager.touchs[1],f=b.getLocalPosition(d);p2.vec2.set(s,f.x,f.y),c.stagePositionToPhysics(q,s);var f=e.getLocalPosition(d);p2.vec2.set(s,f.x,f.y),c.stagePositionToPhysics(r,s),t=p2.vec2.dist(q,r);{d.scale.x,d.scale.y}}else{h=a.global.x,i=a.global.y,l=d.position.x,m=d.position.y,p=!0,c.lastMousePos=a.global;var f=a.getLocalPosition(d);p2.vec2.set(init_stagePosition,f.x,f.y),c.stagePositionToPhysics(init_physicsPosition,init_stagePosition),c.handleMouseDown(init_physicsPosition)}},e.mousemove=e.touchmove=function(a){if(a.originalEvent.touches&&(w!==a.originalEvent.touches.length&&(h=a.global.x,i=a.global.y,l=d.position.x,m=d.position.y),w=a.originalEvent.touches.length),j=a.global.x,k=a.global.y,a.originalEvent.touches&&2===a.originalEvent.touches.length){var b=c.container.interactionManager.touchs[0],e=c.container.interactionManager.touchs[1],f=b.getLocalPosition(d);p2.vec2.set(s,f.x,f.y),c.stagePositionToPhysics(q,s);var f=e.getLocalPosition(d);p2.vec2.set(s,f.x,f.y),c.stagePositionToPhysics(r,s);var g=p2.vec2.dist(q,r);return p2.vec2.add(q,q,r),p2.vec2.scale(q,q,.5),void c.zoom(.5*(b.global.x+e.global.x),.5*(b.global.y+e.global.y),null,g/t*u,g/t*v)}if(p&&c.state===Renderer.PANNING){var n=a.global.x-h+l,o=a.global.y-i+m;d.position.x=n,d.position.y=o}c.lastMousePos=a.global;var f=a.getLocalPosition(d);p2.vec2.set(init_stagePosition,f.x,f.y),c.stagePositionToPhysics(init_physicsPosition,init_stagePosition),c.handleMouseMove(init_physicsPosition)};var x=performance.now();e.mouseup=e.touchend=e.dblclick=function(a){var b=performance.now()-x<300;x=performance.now(),a.originalEvent.touches&&(w=a.originalEvent.touches.length),p=!1,j=a.global.x,k=a.global.y,c.lastMousePos=a.global;var e=a.getLocalPosition(d);p2.vec2.set(init_stagePosition,e.x,e.y),c.stagePositionToPhysics(init_physicsPosition,init_stagePosition),c.handleMouseUp(init_physicsPosition);var f=Math.sqrt(Math.pow(a.global.x-n,2)+Math.pow(a.global.y-o,2));10>f&&(b?c.handleDoubleClick(init_physicsPosition):c.handleClick(init_physicsPosition))},this.element.ontouchmove=function(a){a.preventDefault()},f.addEventListener?(f.addEventListener("mousewheel",a,!1),f.addEventListener("DOMMouseScroll",a,!1)):f.attachEvent("onmousewheel",a),this.centerCamera(0,0)},WebGLRenderer.prototype.zoom=function(a,b,c,d,e,f){var g=this.scrollFactor,h=this.stage;"undefined"==typeof d?(c||(g*=-1),g*=Math.abs(f),h.scale.x*=1+g,h.scale.y*=1+g,h.position.x+=g*(h.position.x-a),h.position.y+=g*(h.position.y-b)):(h.scale.x*=d,h.scale.y*=e,h.position.x+=(d-1)*(h.position.x-a),h.position.y+=(e-1)*(h.position.y-b)),h.updateTransform()},WebGLRenderer.prototype.centerCamera=function(a,b){this.stage.position.x=this.renderer.width/2-this.stage.scale.x*a,this.stage.position.y=this.renderer.height/2-this.stage.scale.y*b},WebGLRenderer.prototype.frame=function(a,b,c,d){var e=this.renderer.width/this.renderer.height;c/d>e?(this.stage.scale.x=this.renderer.width/c,this.stage.scale.y=-this.stage.scale.x):(this.stage.scale.y=-this.renderer.height/d,this.stage.scale.x=-this.stage.scale.y),this.centerCamera(a,b)},WebGLRenderer.prototype.frameAll=function(){for(var a=new p2.AABB,b=0;b<this.bodies.length;b++){var c=this.bodies[b].getAABB();p2.vec2.dist(c.lowerBound,c.upperBound)<1e6&&a.extend(c)}var d=p2.vec2.create();p2.vec2.add(d,a.upperBound,a.lowerBound),p2.vec2.scale(d,d,.5);var e=a.upperBound[0]-a.lowerBound[0],f=a.upperBound[1]-a.lowerBound[1];e>1&&f>1&&this.frame(d[0],d[1],1.5*e,1.5*f)},WebGLRenderer.prototype.drawCircle=function(a,b,c,d,e,f,g,h){g="number"==typeof g?g:1,f="number"==typeof f?f:16777215,a.lineStyle(g,0,1),a.beginFill(f,h?this.sleepOpacity:1),a.drawCircle(b,c,e),a.endFill(),a.moveTo(b,c),a.lineTo(b+e*Math.cos(d),c+e*Math.sin(d))},WebGLRenderer.drawSpring=function(a,b,c,d){d="number"==typeof d?d:1,c="undefined"==typeof c?16777215:c,a.lineStyle(d,c,1),10*d>b&&(b=10*d);var e=12,f=b/e;a.moveTo(-b/2,0);for(var g=1;e>g;g++){var h=-b/2+f*g,i=0;1>=g||g>=e-1||(g%2===0?i-=.1*b:i+=.1*b),a.lineTo(h,i)}a.lineTo(b/2,0)},WebGLRenderer.drawPlane=function(a,b,c,d,e,f,g,h,i){f="number"==typeof f?f:1,d="undefined"==typeof d?16777215:d,a.lineStyle(f,e,1);var j=p2.vec2.fromValues(-i,0),k=p2.vec2.fromValues(i,0),l=p2.vec2.fromValues(i,-i),m=p2.vec2.fromValues(-i,-i);p2.vec2.rotate(j,j,c),p2.vec2.rotate(k,k,c),p2.vec2.rotate(l,l,c),p2.vec2.rotate(m,m,c),p2.vec2.add(j,j,b),p2.vec2.add(k,k,b),p2.vec2.add(l,l,b),p2.vec2.add(m,m,b),a.lineStyle(0,0,0),a.beginFill(d),a.moveTo(j[0],j[1]),a.lineTo(k[0],k[1]),a.lineTo(l[0],l[1]),a.lineTo(m[0],m[1]),a.endFill(),a.lineStyle(f,e),a.moveTo(j[0],j[1]),a.lineTo(k[0],k[1])},WebGLRenderer.drawLine=function(a,b,c,d,e,f){f="number"==typeof f?f:1,e="undefined"==typeof e?0:e,a.lineStyle(f,e,1);var g=p2.vec2.fromValues(-d/2,0),h=p2.vec2.fromValues(d/2,0);p2.vec2.rotate(g,g,c),p2.vec2.rotate(h,h,c),p2.vec2.add(g,g,b),p2.vec2.add(h,h,b),a.moveTo(g[0],g[1]),a.lineTo(h[0],h[1])},WebGLRenderer.prototype.drawCapsule=function(a,b,c,d,e,f,g,h,i,j){i="number"==typeof i?i:1,g="undefined"==typeof g?0:g,a.lineStyle(i,g,1);var k=p2.vec2,l=(Math.cos(d),Math.sin(d),e/2);a.beginFill(h,j?this.sleepOpacity:1);var m=k.fromValues(b,c),n=k.fromValues(-l,0),o=k.fromValues(l,0);k.rotate(n,n,d),k.rotate(o,o,d),k.add(n,n,m),k.add(o,o,m),a.drawCircle(n[0],n[1],f),a.drawCircle(o[0],o[1],f),a.endFill();var p=k.create(),q=k.create();k.set(n,-l,f),k.set(o,l,f),k.set(p,l,-f),k.set(q,-l,-f),k.rotate(n,n,d),k.rotate(o,o,d),k.rotate(p,p,d),k.rotate(q,q,d),k.add(n,n,m),k.add(o,o,m),k.add(p,p,m),k.add(q,q,m),a.lineStyle(i,g,0),a.beginFill(h,j?this.sleepOpacity:1),a.moveTo(n[0],n[1]),a.lineTo(o[0],o[1]),a.lineTo(p[0],p[1]),a.lineTo(q[0],q[1]),a.endFill();for(var r=0;2>r;r++){a.lineStyle(i,g,1);var s=0===r?1:-1;k.set(n,-l,s*f),k.set(o,l,s*f),k.rotate(n,n,d),k.rotate(o,o,d),k.add(n,n,m),k.add(o,o,m),a.moveTo(n[0],n[1]),a.lineTo(o[0],o[1])}},WebGLRenderer.prototype.drawRectangle=function(a,b,c,d,e,f,g,h,i,j){for(var k=[[e/2,f/2],[-e/2,f/2],[-e/2,-f/2],[e/2,-f/2]],l=0;l<k.length;l++){var m=k[l];p2.vec2.rotate(m,m,d),p2.vec2.add(m,m,[b,c])}this.drawPath(a,k,g,h,i,j)},WebGLRenderer.prototype.drawConvex=function(a,b,c,d,e,f,g,h,i){if(f="number"==typeof f?f:1,d="undefined"==typeof d?0:d,g){for(var j=[16711680,65280,255],k=0;k!==b.length+1;k++){var l=b[k%b.length],m=b[(k+1)%b.length],n=l[0],o=l[1],p=m[0],q=m[1];a.lineStyle(f,j[k%j.length],1),a.moveTo(n,o),a.lineTo(p,q),a.drawCircle(n,o,2*f)}a.lineStyle(f,0,1),a.drawCircle(h[0],h[1],2*f)}else{a.lineStyle(f,d,1),a.beginFill(e,i?this.sleepOpacity:1);for(var k=0;k!==b.length;k++){var r=b[k],s=r[0],t=r[1];0===k?a.moveTo(s,t):a.lineTo(s,t)}a.endFill(),b.length>2&&(a.moveTo(b[b.length-1][0],b[b.length-1][1]),a.lineTo(b[0][0],b[0][1]))}},WebGLRenderer.prototype.drawPath=function(a,b,c,d,e,f){e="number"==typeof e?e:1,c="undefined"==typeof c?0:c,a.lineStyle(e,c,1),"number"==typeof d&&a.beginFill(d,f?this.sleepOpacity:1);for(var g=null,h=null,i=0;i<b.length;i++){var j=b[i],k=j[0],l=j[1];if(k!==g||l!==h){if(0===i)a.moveTo(k,l);else{var m=g,n=h,o=k,p=l,q=b[(i+1)%b.length][0],r=b[(i+1)%b.length][1],s=(o-m)*(r-n)-(q-m)*(p-n);0!==s&&a.lineTo(k,l)}g=k,h=l}}"number"==typeof d&&a.endFill(),b.length>2&&"number"==typeof d&&(a.moveTo(b[b.length-1][0],b[b.length-1][1]),a.lineTo(b[0][0],b[0][1]))},WebGLRenderer.prototype.updateSpriteTransform=function(a,b){this.useInterpolatedPositions?(a.position.x=b.interpolatedPosition[0],a.position.y=b.interpolatedPosition[1],a.rotation=b.interpolatedAngle):(a.position.x=b.position[0],a.position.y=b.position[1],a.rotation=b.angle)};var tmpAABB=new p2.AABB,X=p2.vec2.fromValues(1,0),distVec=p2.vec2.fromValues(0,0),worldAnchorA=p2.vec2.fromValues(0,0),worldAnchorB=p2.vec2.fromValues(0,0);WebGLRenderer.prototype.render=function(){for(var a=(this.renderer.width,this.renderer.height,this.springSprites),b=(this.sprites,0);b!==this.bodies.length;b++)this.updateSpriteTransform(this.sprites[b],this.bodies[b]);for(var b=0;b!==this.bodies.length;b++){var c=this.bodies[b].sleepState===p2.Body.SLEEPING,d=this.sprites[b],e=this.bodies[b];d.drawnSleeping!==c&&(d.clear(),this.drawRenderable(e,d,d.drawnColor,d.drawnLineColor))}for(var b=0;b!==this.springs.length;b++){var f=this.springs[b],d=a[b],g=f.bodyA,h=f.bodyB;if(f instanceof p2.LinearSpring){if(this.useInterpolatedPositions?(p2.vec2.toGlobalFrame(worldAnchorA,f.localAnchorA,g.interpolatedPosition,g.interpolatedAngle),p2.vec2.toGlobalFrame(worldAnchorB,f.localAnchorB,h.interpolatedPosition,h.interpolatedAngle)):(f.getWorldAnchorA(worldAnchorA),f.getWorldAnchorB(worldAnchorB)),d.scale.y=1,worldAnchorA[1]<worldAnchorB[1]){var i=worldAnchorA;worldAnchorA=worldAnchorB,worldAnchorB=i,d.scale.y=-1}var j=worldAnchorA[0],k=worldAnchorA[1],l=worldAnchorB[0],m=worldAnchorB[1];d.position.x=(j+l)/2,d.position.y=(k+m)/2,distVec[0]=j-l,distVec[1]=k-m,d.rotation=Math.acos(p2.vec2.dot(X,distVec)/p2.vec2.length(distVec)),d.scale.x=p2.vec2.length(distVec)/f.restLength}}if(this.drawContacts){this.contactGraphics.clear(),this.stage.removeChild(this.contactGraphics),this.stage.addChild(this.contactGraphics);var n=this.contactGraphics;n.lineStyle(this.lineWidth,0,1);for(var b=0;b!==this.world.narrowphase.contactEquations.length;b++){var o=this.world.narrowphase.contactEquations[b],p=o.bodyA,q=o.bodyB,r=o.contactPointA,s=o.contactPointB,t=p.position[0],u=p.position[1],v=q.position[0],w=q.position[1];n.moveTo(t,u),n.lineTo(t+r[0],u+r[1]),n.moveTo(v,w),n.lineTo(v+s[0],w+s[1])}this.contactGraphics.cleared=!1}else this.contactGraphics.cleared||(this.contactGraphics.clear(),this.contactGraphics.cleared=!0);if(this.drawAABBs){this.aabbGraphics.clear(),this.stage.removeChild(this.aabbGraphics),this.stage.addChild(this.aabbGraphics);var n=this.aabbGraphics;n.lineStyle(this.lineWidth,0,1);for(var b=0;b!==this.world.bodies.length;b++){var x=this.world.bodies[b].getAABB();n.drawRect(x.lowerBound[0],x.lowerBound[1],x.upperBound[0]-x.lowerBound[0],x.upperBound[1]-x.lowerBound[1])}this.aabbGraphics.cleared=!1}else this.aabbGraphics.cleared||(this.aabbGraphics.clear(),this.aabbGraphics.cleared=!0);var n=this.selectionGraphics;n.clear(),this.stage.removeChild(n),this.stage.addChild(n),n.lineStyle(3*this.lineWidth,0,1);for(var b=0;this.paused&&b!==this.selection.length;b++){var y=this.selection[b];if(y instanceof p2.Body&&y.shapes.length){var x=y.getAABB();n.drawRect(x.lowerBound[0],x.lowerBound[1],x.upperBound[0]-x.lowerBound[0],x.upperBound[1]-x.lowerBound[1])}if(y instanceof p2.Shape){for(var z,A,B=[0,0],C=0,D=this.world,E=0;E<D.bodies.length;E++)for(var e=D.bodies[E],F=0;F<e.shapes.length;F++){var G=e.shapes[F];if(G.id===y.id){z=e,A=G,p2.vec2.copy(B,e.shapeOffsets[F]),C=e.shapeAngles[F];break}}z&&(z.toWorldFrame(B,B),A.computeAABB(tmpAABB,B,z.angle+C),n.drawRect(tmpAABB.lowerBound[0],tmpAABB.lowerBound[1],tmpAABB.upperBound[0]-tmpAABB.lowerBound[0],tmpAABB.upperBound[1]-tmpAABB.lowerBound[1]))}}this.renderer.render(this.container)},WebGLRenderer.prototype.drawRenderable=function(a,b,c,d){var e=this.lineWidth,f=[0,0];if(b.drawnSleeping=!1,b.drawnColor=c,b.drawnLineColor=d,a instanceof p2.Body&&a.shapes.length){var g=a.sleepState===p2.Body.SLEEPING;if(b.drawnSleeping=g,a.concavePath&&!this.debugPolygons){for(var h=[],i=0;i!==a.concavePath.length;i++){var j=a.concavePath[i];h.push([j[0],j[1]])}this.drawPath(b,h,d,c,e,g)}else for(var k=0;k<a.shapes.length;k++){var l=a.shapes[k],m=a.shapeOffsets[k],n=a.shapeAngles[k];if(m=m||f,n=n||0,l instanceof p2.Circle)this.drawCircle(b,m[0],m[1],n,l.radius,l.color,e,g);else if(l instanceof p2.Particle)this.drawCircle(b,m[0],m[1],n,2*e,d,0);else if(l instanceof p2.Plane)WebGLRenderer.drawPlane(b,m,n,l.color,d,e,10*e,10*e,1e3);else if(l instanceof p2.Line)WebGLRenderer.drawLine(b,m,n,l.length,d,e);else if(l instanceof p2.Rectangle)this.drawRectangle(b,m[0],m[1],n,l.width,l.height,d,l.color,e,g);else if(l instanceof p2.Capsule)this.drawCapsule(b,m[0],m[1],n,l.length,l.radius,d,l.color,e,g);else if(l instanceof p2.Convex){for(var o=[],p=p2.vec2.create(),i=0;i!==l.vertices.length;i++){var j=l.vertices[i];p2.vec2.rotate(p,j,n),o.push([p[0]+m[0],p[1]+m[1]])}this.drawConvex(b,o,l.triangles,d,l.color,e,this.debugPolygons,[m[0],-m[1]],g)}else if(l instanceof p2.Heightfield){for(var h=[[0,-100]],i=0;i!==l.data.length;i++){var j=l.data[i];h.push([i*l.elementWidth,j])}h.push([l.data.length*l.elementWidth,-100]),this.drawPath(b,h,d,l.color,e,g)}}}else if(a instanceof p2.LinearSpring){var q=a.restLength;WebGLRenderer.drawSpring(b,q,0,e)}},WebGLRenderer.prototype.addRenderable=function(a){var b=(this.lineWidth,parseInt(randomPastelHex(),16)),c=0,d=new PIXI.Graphics;a instanceof p2.Body&&a.shapes.length?(this.drawRenderable(a,d,b,c),this.sprites.push(d),this.stage.addChild(d)):a instanceof p2.Spring&&(this.drawRenderable(a,d,0,c),this.springSprites.push(d),this.stage.addChild(d))},WebGLRenderer.prototype.removeRenderable=function(a){if(a instanceof p2.Body){var b=this.bodies.indexOf(a);-1!==b&&(this.stage.removeChild(this.sprites[b]),this.sprites.splice(b,1))}else if(a instanceof p2.Spring){var b=this.springs.indexOf(a);-1!==b&&(this.stage.removeChild(this.springSprites[b]),this.springSprites.splice(b,1))}},WebGLRenderer.prototype.resize=function(a,b){{var c=this.renderer;c.view}c.resize(a,b)},Handler.idCounter=1,Handler.prototype.getById=function(a){return this.objects[a]},Handler.prototype.update=function(){},Handler.prototype.add=function(){},Handler.prototype.remove=function(a){delete this.objects[a.id]
},Handler.prototype.create=function(){},Handler.prototype.createId=function(){return Handler.idCounter++},Handler.prototype.getIdOf=function(a){for(var b in this.objects)if(this.objects[b]===a)return parseInt(b,10);return-1},Handler.prototype.duplicate=function(a){var b=this.create(),c=b.id;for(var d in b)b[d]=a[d];return b.id=c,b},RendererHandler.prototype=Object.create(Handler.prototype),RendererHandler.prototype.create=function(){return{contacts:!1,aabbs:!1,constraints:!1}},RendererHandler.prototype.update=function(a){var b=this.renderer;b.drawAABBs=a.aabbs},SolverHandler.prototype=Object.create(Handler.prototype),SolverHandler.prototype.create=function(){return{iterations:10,stiffness:1e6,relaxation:4,tolerance:1e-4}},SolverHandler.prototype.update=function(a){var b=this.world;b.solver.iterations=a.iterations,b.solver.tolerance=a.tolerance},ShapeHandler.prototype=Object.create(Handler.prototype),ShapeHandler.prototype.update=function(a,b){var c=this.sceneHandler.bodyHandler.getById(a.id),d=this.objects[b.id];d||(this.add(a,b),d=this.objects[b.id]);var e=c.shapes.indexOf(d),f=d.color;switch(b.type){case"circle":d=new p2.Circle(b.radius);break;case"box":d=new p2.Rectangle(b.width,b.height);break;case"plane":d=new p2.Plane;break;case"capsule":d=new p2.Capsule(b.length,b.radius)}this.objects[b.id]=c.shapes[e]=d,d.id=b.id,d.color=f,d.color=parseInt(b.color.replace("#",""),16);var g=this.sceneHandler.materialHandler.getById(a.material);g&&(d.material=g),d.collisionGroup=a.collisionGroup,d.collisionMask=a.collisionMask,c.shapeOffsets[e].set([b.x,b.y]),c.shapeAngles[e]=b.angle,this.bodyChanged(c)},ShapeHandler.prototype.add=function(a,b){var c,d=this.sceneHandler.bodyHandler.getById(a.id);switch(b.type){case"circle":c=new p2.Circle(b.radius);break;case"box":c=new p2.Rectangle(b.width,b.height);break;case"plane":c=new p2.Plane;break;case"capsule":c=new p2.Capsule(b.length,b.radius)}var e=this.sceneHandler.materialHandler.getById(a.material);e&&(c.material=e),this.objects[b.id]=c,d.addShape(c,[b.x,b.y],b.angle),this.update(a,b)},ShapeHandler.prototype.remove=function(a,b){var c=this.objects[b.id],d=this.sceneHandler.bodyHandler.getById(a);d.removeShape(c),this.bodyChanged(d),delete this.objects[b.id]},ShapeHandler.prototype.bodyChanged=function(a){a.updateMassProperties(),a.updateAABB(),this.renderer.removeVisual(a),this.renderer.addVisual(a)},ShapeHandler.prototype.create=function(){var a=this.createId();return{id:a,name:"Shape "+a,type:"circle",color:"#"+Color.randomPastelHex(),angle:0,x:0,y:0,collisionResponse:!0,radius:1,length:1,width:1,height:1,vertices:[]}},WorldHandler.prototype=Object.create(Handler.prototype),WorldHandler.prototype.update=function(a){var b=this.world;b.gravity.set([a.gravityX,a.gravityY]),this.renderer.maxSubSteps=a.maxSubSteps,this.renderer.timeStep=1/a.fps},WorldHandler.prototype.create=function(){return{gravityX:0,gravityY:-10,fps:60,maxSubSteps:3,sleepMode:"NO_SLEEPING"}},SpringHandler.prototype=Object.create(Handler.prototype),SpringHandler.prototype.create=function(){var a=this.createId();return{id:a,type:"linear",name:"Spring "+a,stiffness:100,damping:1,bodyA:0,bodyB:0,useInitialRestLength:!0,restLength:0,localAnchorAX:0,localAnchorAY:0,localAnchorBX:0,localAnchorBY:0}},SpringHandler.prototype.update=function(a){var b=this.sceneHandler.bodyHandler.getById(a.bodyA),c=this.sceneHandler.bodyHandler.getById(a.bodyB),d=this.objects[a.id];if(d&&(this.renderer.removeVisual(d),this.world.removeSpring(d)),b&&c){switch(a.type){case"linear":var e={stiffness:a.stiffness,damping:a.damping,localAnchorA:[a.localAnchorAX,a.localAnchorAY],localAnchorB:[a.localAnchorBX,a.localAnchorBY]};a.useInitialRestLength||(e.restLength=a.restLength),d=new p2.LinearSpring(b,c,e);break;case"rotational":var e={stiffness:a.stiffness,damping:a.damping};a.useInitialRestLength||(e.restAngle=a.restLength),d=new p2.RotationalSpring(b,c,e)}this.world.addSpring(d),this.objects[a.id]=d,this.renderer.addVisual(d)}},SpringHandler.prototype.remove=function(a){{var b=this.objects[a.id];this.sceneHandler.bodyHandler.getById(a.bodyA),this.sceneHandler.bodyHandler.getById(a.bodyB)}b&&(this.renderer.removeVisual(b),this.world.removeSpring(b)),delete this.objects[a.id]},SpringHandler.prototype.add=function(a){this.objects[a.id]||this.update(a)},ConstraintHandler.prototype=Object.create(Handler.prototype),ConstraintHandler.prototype.create=function(){var a=this.createId();return{id:a,type:"hinge",name:"Constraint "+a,stiffness:p2.Equation.DEFAULT_STIFFNESS,relaxation:p2.Equation.DEFAULT_RELAXATION,bodyA:0,bodyB:0,collideConnected:!1,maxForce:1e9,localAnchorAX:0,localAnchorAY:0,localAnchorBX:0,localAnchorBY:0,useCurrentDistance:!0,distance:1,upperLimitEnabled:!1,lowerLimitEnabled:!1,upperLimit:1,lowerLimit:0,ratio:1,useCurrentRelAngle:!0,relAngle:0,localAxisAX:0,localAxisAY:1,disableRotationalLock:!1,motorEnabled:!1,motorSpeed:1}},ConstraintHandler.prototype.update=function(a){var b=this.sceneHandler.bodyHandler.getById(a.bodyA),c=this.sceneHandler.bodyHandler.getById(a.bodyB),d=this.getById(a.id);if(d&&this.world.removeConstraint(d),b&&c){var e;switch(a.type){case"distance":e={localAnchorA:[a.localAnchorAX,a.localAnchorAY],localAnchorB:[a.localAnchorBX,a.localAnchorBY],maxForce:a.maxForce},a.useCurrentDistance||(e.distance=a.distance),d=new p2.DistanceConstraint(b,c,e),d.upperLimitEnabled=a.upperLimitEnabled,d.lowerLimitEnabled=a.lowerLimitEnabled,d.upperLimit=a.upperLimit,d.lowerLimit=a.lowerLimit;break;case"lock":d=new p2.LockConstraint(b,c,{maxForce:a.maxForce});break;case"slider":e={localAnchorA:[a.localAnchorAX,a.localAnchorAY],localAnchorB:[a.localAnchorBX,a.localAnchorBY],localAxisA:[a.localAxisAX,a.localAxisAY],disableRotationalLock:a.disableRotationalLock,maxForce:a.maxForce},d=new p2.PrismaticConstraint(b,c,e),a.motorEnabled&&(d.enableMotor(),d.motorSpeed=a.motorSpeed);break;case"hinge":var f=p2.vec2.create(),g=[a.localAnchorAX,a.localAnchorAY];p2.vec2.rotate(f,g,b.angle),p2.vec2.add(f,f,b.position),p2.vec2.subtract(f,f,c.position),p2.vec2.rotate(f,f,-c.angle),e={localPivotA:g,localPivotB:f,maxForce:a.maxForce},d=new p2.RevoluteConstraint(b,c,e),d.upperLimitEnabled=a.upperLimitEnabled,d.lowerLimitEnabled=a.lowerLimitEnabled,d.upperLimit=a.upperLimit,d.lowerLimit=a.lowerLimit,a.motorEnabled&&(d.enableMotor(),d.setMotorSpeed(a.motorSpeed));break;case"gear":e={ratio:a.ratio,maxTorque:a.maxForce},a.useCurrentRelAngle||(e.angle=a.relAngle),d=new p2.GearConstraint(b,c,e)}d.setStiffness(a.stiffness),d.setRelaxation(a.relaxation),d.collideConnected=a.collideConnected,this.objects[a.id]=d,this.world.addConstraint(d)}},ConstraintHandler.prototype.remove=function(a){var b=this.getById(a.id);b&&(this.world.removeConstraint(b),delete this.objects[a.id])},ConstraintHandler.prototype.add=function(a){this.objects[a.id]||this.update(a)},MachineHandler.prototype=Object.create(Handler.prototype),MachineHandler.prototype.create=function(){var a=this.createId(),b={id:a,name:"State machine "+a,states:[],log:!1};return b},MachineHandler.prototype.duplicate=function(a){var b=Handler.prototype.duplicate.call(this,a);return b.states=b.states.map(function(a){return this.sceneHandler.stateHandler.duplicate(a)}),b},MachineHandler.prototype.add=function(a,b){if(!this.getById(a.id)){var c=this.sceneHandler.bodyHandler.getById(b.id);this.objects[a.id]=new Machine(this.world,c,{}),this.update(a)}},MachineHandler.prototype.remove=function(a){delete this.objects[a.id]},MachineHandler.prototype.update=function(a,b){var c=this.getById(a.id);if(!c){var d=this.sceneHandler.bodyHandler.getById(b.id);c=this.objects[a.id]=new Machine(this.world,d,{})}c.logging=a.log},MachineHandler.prototype.stopAllMachines=function(){for(var a=Object.keys(this.objects),b=0;b<a.length;b++){var c=this.objects[a[b]];c.stop()}},MaterialHandler.prototype=Object.create(Handler.prototype),MaterialHandler.prototype.create=function(a){var b=this.createId(),c={id:b,name:a||"Material "+b};return c},MaterialHandler.prototype.add=function(a){if(!this.getById(a.id)){var b=this.objects[a.id]=new p2.Material;return this.update(a),b}},MaterialHandler.prototype.remove=function(a){delete this.objects[a.id]},MaterialHandler.prototype.update=function(a){var b=this.getById(a.id);b||(b=this.objects[a.id]=new p2.Material)},ContactMaterialHandler.prototype=Object.create(Handler.prototype),ContactMaterialHandler.prototype.create=function(a){var b=this.createId(),c={id:b,name:a||"ContactMaterial "+b,materialA:0,materialB:0,friction:.3,restitution:0,stiffness:p2.Equation.DEFAULT_STIFFNESS,relaxation:p2.Equation.DEFAULT_RELAXATION,frictionStiffness:p2.Equation.DEFAULT_STIFFNESS,frictionRelaxation:p2.Equation.DEFAULT_RELAXATION,surfaceVelocity:0};return c},ContactMaterialHandler.prototype.createIceIce=function(a){var b=this.create("Ice / ice");return b.friction=0,b.materialA=b.materialB=a.id,b},ContactMaterialHandler.prototype.createWoodWood=function(a){var b=this.create("Wood / wood");return b.friction=.3,b.materialA=b.materialB=a.id,b},ContactMaterialHandler.prototype.createIceWood=function(a,b){var c=this.create("Ice / wood");return c.friction=.1,c.materialA=a.id,c.materialB=b.id,c},ContactMaterialHandler.prototype.add=function(a){if(!this.getById(a.id)){var b=this.sceneHandler.materialHandler.getById(a.materialA),c=this.sceneHandler.materialHandler.getById(a.materialB);if(b&&c){var d=this.objects[a.id]=new p2.ContactMaterial(b,c,{});this.world.addContactMaterial(d)}this.update(a)}},ContactMaterialHandler.prototype.remove=function(a){var b=this.getById(a.id);b&&this.world.removeContactMaterial(b),delete this.objects[a.id]},ContactMaterialHandler.prototype.update=function(a){var b=this.getById(a.id),c=this.sceneHandler.materialHandler.getById(a.materialA),d=this.sceneHandler.materialHandler.getById(a.materialB);!b&&c&&d&&(b=this.objects[a.id]=new p2.ContactMaterial(c,d),this.world.addContactMaterial(b)),b&&(b.materialA=c,b.materialB=d,b.friction=a.friction,b.restitution=a.restitution,b.stiffness=a.stiffness,b.relaxation=a.relaxation,b.frictionStiffness=a.frictionStiffness,b.frictionRelaxation=a.frictionRelaxation,b.surfaceVelocity=a.surfaceVelocity)},BodyHandler.prototype=Object.create(Handler.prototype),BodyHandler.prototype.create=function(){var a=this.createId(),b={id:a,name:"Body "+a,material:0,x:0,y:0,angle:0,type:"dynamic",mass:1,collisionResponse:!0,shapes:[],velocityX:0,velocityY:0,angularVelocity:0,damping:0,angularDamping:0,fixedRotation:!1,collisionMask:1,collisionGroup:1,enableSleep:!1,gravityScale:1,machines:[]};return b},BodyHandler.prototype.duplicate=function(a){var b=this.create(),c=b.id;for(var d in b)b[d]=a[d];return b.id=c,b.shapes=b.shapes.map(function(a){return this.sceneHandler.shapeHandler.duplicate(a)}),b.machines=b.machines.map(function(a){return this.sceneHandler.machineHandler.duplicate(a)}),b},BodyHandler.prototype.update=function(a){var b=this.objects[a.id];b||(this.add(a),b=this.objects[a.id]),b.mass=a.mass,b.position.set([a.x,a.y]),b.angle=a.angle,b.velocity.set([a.velocityX,a.velocityY]),b.angularVelocity=a.angularVelocity,b.damping=a.damping,b.angularDamping=a.angularDamping,b.collisionResponse=a.collisionResponse,b.fixedRotation=a.fixedRotation,b.enableSleep=a.enableSleep,b.gravityScale=a.gravityScale,b.resetConstraintVelocity(),b.type={dynamic:p2.Body.DYNAMIC,kinematic:p2.Body.KINEMATIC,"static":p2.Body.STATIC}[a.type],"static"===a.type&&(b.velocity.set([0,0]),b.angularVelocity=0,b.mass=0),b.updateAABB(),b.updateMassProperties(),this.renderer.removeVisual(b),this.renderer.addVisual(b)},BodyHandler.prototype.add=function(a){if(!this.objects[a.id]){var b=new p2.Body({mass:a.mass});this.objects[a.id]=b,this.world.addBody(b)}},BodyHandler.prototype.remove=function(a){var b=this.objects[a.id];b&&this.world.removeBody(b),delete this.objects[a.id]},ActionHandler.prototype=Object.create(Handler.prototype),ActionHandler.prototype.create=function(){var a=this.createId();return{id:a,type:"wait",time:1,toState:0,positionX:0,positionY:0,angle:0,velocityX:0,velocityY:0,angularVelocity:0,forceX:0,forceY:0,angularForce:0,localFrame:!1,keyCode:-1,eventType:"keydown"}},ActionHandler.prototype.add=function(a,b){if(!this.getById(a.id)){var c=this.sceneHandler.stateHandler.getById(b.id),d=new Action;d.state=c,c.actions.push(d),this.objects[a.id]=d,this.update(a)}},ActionHandler.prototype.remove=function(a){var b=this.getById(a.id),c=b.state.actions.indexOf(b);-1!==c&&b.state.actions.splice(c,1),delete this.objects[a.id]},ActionHandler.prototype.update=function(a,b){var c,d,e=this.getById(a.id);switch(d=e?e.state:this.sceneHandler.stateHandler.getById(b.id),a.type){case"wait":var f=this.sceneHandler.stateHandler.getById(a.toState);c=new WaitAction({time:a.time}),f&&(c.toState=f);break;case"setPosition":c=new SetPositionAction({position:[a.positionX,a.positionY],angle:a.angle});break;case"setVelocity":c=new SetVelocityAction({velocity:[a.velocityX,a.velocityY],angularVelocity:a.angularVelocity,localFrame:a.localFrame});break;case"addForce":c=new AddForceAction({force:[a.forceX,a.forceY],angularForce:a.angularForce,localFrame:a.localFrame});break;case"key":c=new KeyAction({keyCode:a.keyCode,eventType:a.eventType});var f=this.sceneHandler.stateHandler.getById(a.toState);f&&(c.toState=f);break;default:throw new Error("Action type not recognized: "+a.type)}this.objects[a.id]=c,c.state=d;var g=d.actions.indexOf(e);-1!==g?d.actions[g]=c:d.actions.push(c)},StateHandler.prototype=Object.create(Handler.prototype),StateHandler.prototype.create=function(){var a=this.createId();return{id:a,name:"State "+a,actions:[]}},StateHandler.prototype.add=function(a,b){this.getById(a.id)||this.update(a,b)},StateHandler.prototype.remove=function(a){var b=this.getById(a.id),c=b.machine.states.indexOf(b);-1!==c&&b.machine.states.splice(c,1),delete this.objects[a.id]},StateHandler.prototype.update=function(a,b){var c=this.getById(a.id);if(!c){var d=this.sceneHandler.machineHandler.getById(b.id);c=new State(d),d.states.push(c),this.objects[a.id]=c}},StateHandler.prototype.duplicate=function(a){var b=Handler.prototype.duplicate.call(this,a);return b.actions=b.actions.map(function(a){return this.sceneHandler.actionHandler.duplicate(a)}),b},SceneHandler.prototype.getById=function(a){return this.bodyHandler.getById(a)||this.shapeHandler.getById(a)||this.springHandler.getById(a)||this.machineHandler.getById(a)||this.stateHandler.getById(a)},SceneHandler.prototype.getIdOf=function(a){var b;return b=this.bodyHandler.getIdOf(a),-1!==b?b:(b=this.shapeHandler.getIdOf(a),-1!==b?b:(b=this.springHandler.getIdOf(a),-1!==b?b:(b=this.machineHandler.getIdOf(a),-1!==b?b:b=this.stateHandler.getIdOf(a))))},SceneHandler.prototype.findMaxId=function(a){var b=function(a,b){return a.id>b.id?a:b},c=1,d=a.bodies.concat(a.springs).concat(a.constraints);if(d.length){var e=d.reduce(b);e&&(c=Math.max(e.id,c))}for(var f=0;f<a.bodies.length;f++){var g=a.bodies[f];if(g.shapes.length){var e=g.shapes.reduce(b);e&&(c=Math.max(e.id,c))}}return c},SceneHandler.prototype.updateAll=function(a){for(b=0;b<a.materials.length;b++)this.materialHandler.update(a.materials[b]);for(b=0;b<a.contactMaterials.length;b++)this.contactMaterialHandler.update(a.contactMaterials[b]);for(var b=0;b<a.bodies.length;b++){var c=a.bodies[b];this.bodyHandler.update(c);for(var d=0;d<c.shapes.length;d++)this.shapeHandler.update(c,c.shapes[d]);for(d=0;d<c.machines.length;d++){var e=c.machines[d];this.machineHandler.update(e,c);for(var f=0;f<e.states.length;f++){var g=e.states[f];this.stateHandler.update(g,e)}for(var f=0;f<e.states.length;f++)for(var g=e.states[f],h=0;h<g.actions.length;h++)this.actionHandler.update(g.actions[h],g)}}for(b=0;b<a.springs.length;b++){var i=a.springs[b];this.springHandler.update(i)}for(b=0;b<a.constraints.length;b++){var j=a.constraints[b];this.constraintHandler.update(j)}this.rendererHandler.update(a.renderer),this.solverHandler.update(a.solver),this.worldHandler.update(a.world)},SceneHandler.prototype.stopSimulation=function(){this.machineHandler.stopAllMachines()},SceneHandler.prototype.createDefaultScene=function(){var a=this.materialHandler.create("Ice"),b=this.materialHandler.create("Wood");return{world:{gravityX:0,gravityY:-10,fps:60,maxSubSteps:3,sleepMode:"NO_SLEEPING"},renderer:this.rendererHandler.create(),solver:this.solverHandler.create(),bodies:[],springs:[],constraints:[],materials:[a,b],contactMaterials:[this.contactMaterialHandler.createIceIce(a),this.contactMaterialHandler.createWoodWood(b),this.contactMaterialHandler.createIceWood(a,b)]}},Machine.prototype.log=function(a){this.logging&&console.log("Machine "+this.id+": "+a)},Machine.prototype.update=function(){if(!this.currentState){if(this.currentState=this.defaultState||this.states[0],!this.currentState)return;this.log("Entering default state"),this.currentState.enter(this),this.transition()}for(var a=!0;a;)this.requestTransitionToState=null,this.currentState&&this.currentState.update(this),a=this.transition()},Machine.prototype.transition=function(){var a=!1;return this.requestTransitionToState?(a=!0,this.currentState&&this.currentState.exit(this),this.currentState=this.requestTransitionToState,this.requestTransitionToState.enter(this)):a=!1,a},Machine.prototype.stop=function(){this.currentState&&(this.currentState.exit(this),this.currentState=null)},State.id=1,State.prototype.enter=function(){this.machine.log("Entered state "+this.id);for(var a=0;a<this.actions.length;a++)this.actions[a].enter(this.machine)},State.prototype.update=function(){this.machine.log("Updating state "+this.id);for(var a=0;a<this.actions.length;a++)this.actions[a].update(this.machine)},State.prototype.exit=function(){this.machine.log("Exiting state "+this.id);for(var a=0;a<this.actions.length;a++)this.actions[a].exit(this.machine)},Action.prototype.enter=function(){},Action.prototype.update=function(){},Action.prototype.exit=function(){},KeyAction.prototype=Object.create(Action.prototype),KeyAction.prototype.enter=function(){var a=this;-1!==["keydown","keyup"].indexOf(this.eventType)&&(this.eventHandler=function(b){b.keyCode===a.keyCode&&(a.triggered=!0)},document.addEventListener(this.eventType,this.eventHandler))},KeyAction.prototype.update=function(a){this.triggered&&(a.requestTransitionToState=this.toState,this.triggered=!1)},KeyAction.prototype.exit=function(){this.eventHandler&&document.removeEventListener(this.eventType,this.eventHandler),this.eventHandler=null,this.triggered=!1},SetPositionAction.prototype=Object.create(Action.prototype),SetPositionAction.prototype.enter=function(a){a.parent.position.set(this.position),a.parent.angle=this.angle},SetPositionAction.prototype.update=function(){},SetPositionAction.prototype.exit=function(){},SetVelocityAction.prototype=Object.create(Action.prototype),SetVelocityAction.prototype.enter=function(a){a.parent.velocity.set(this.velocity),a.parent.angularVelocity=this.angularVelocity},SetVelocityAction.prototype.update=function(){},SetVelocityAction.prototype.exit=function(){},WaitAction.prototype=Object.create(Action.prototype),WaitAction.prototype.enter=function(a){this.enterTime=a.world.time},WaitAction.prototype.update=function(a){a.world.time>=this.enterTime+this.time&&this.toState&&(a.requestTransitionToState=this.toState)},WaitAction.prototype.exit=function(){this.enterTime=-1},AddForceAction.prototype=Object.create(Action.prototype),AddForceAction.prototype.enter=function(){},AddForceAction.prototype.update=function(a){p2.vec2.copy(this.tmpVec,this.force),this.localFrame&&p2.vec2.rotate(this.tmpVec,this.tmpVec,a.parent.angle),p2.vec2.add(a.parent.force,this.tmpVec,a.parent.force),a.parent.angularForce+=this.angularForce},AddForceAction.prototype.exit=function(){};